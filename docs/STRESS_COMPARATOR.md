# StressComparator - Compara√ß√£o Baseline vs Atual

## üìã Vis√£o Geral

O **StressComparator** √© o componente respons√°vel por comparar snapshots atuais de HPAs com o baseline capturado antes do stress test, detectando degrada√ß√µes e anomalias em tempo real.

**Localiza√ß√£o**: `internal/analyzer/stress_comparator.go`
**Testes**: `internal/analyzer/stress_comparator_test.go` (9/9 testes ‚úÖ)

## üéØ Funcionalidades

### 1. Compara√ß√£o Scan a Scan

- Compara cada snapshot atual com o baseline correspondente
- Calcula deltas absolutos e percentuais para todas as m√©tricas
- Detecta excedentes de thresholds configur√°veis
- Classifica o status: **NORMAL**, **DEGRADED** ou **CRITICAL**

### 2. M√©tricas Comparadas

| M√©trica | Delta Absoluto | Delta Percentual | Threshold |
|---------|----------------|------------------|-----------|
| **CPU** | CPUCurrent - CPUBaseline | (Delta / Baseline) √ó 100 | Degraded: 30%, Critical: 50% |
| **Mem√≥ria** | MemoryCurrent - MemoryBaseline | (Delta / Baseline) √ó 100 | Degraded: 30%, Critical: 50% |
| **R√©plicas** | ReplicasCurrent - ReplicasBaseline | (Delta / Baseline) √ó 100 | Degraded: +3, Critical: +5 |
| **Taxa de Erros** | ErrorRateCurrent - ErrorRateBaseline | Delta absoluto | Critical: +5% |
| **Lat√™ncia P95** | LatencyCurrent - LatencyBaseline | (Delta / Baseline) √ó 100 | Critical: +100% |

### 3. Status de Compara√ß√£o

#### NORMAL ‚úÖ
- Todas as m√©tricas dentro dos limites esperados
- Varia√ß√µes menores que thresholds de degrada√ß√£o
- HPA operando de forma saud√°vel

#### DEGRADED ‚ö†Ô∏è
- Uma ou mais m√©tricas excederam threshold de degrada√ß√£o
- Ainda n√£o atingiu n√≠veis cr√≠ticos
- Requer aten√ß√£o mas n√£o √© urgente

**Exemplo**: CPU aumentou 35% (threshold degraded: 30%)

#### CRITICAL üö®
- Uma ou mais m√©tricas excederam threshold cr√≠tico
- Degrada√ß√£o significativa detectada
- Requer a√ß√£o imediata

**Exemplo**: CPU aumentou 60% (threshold critical: 50%)

## üîß Componentes

### ComparisonResult

Resultado detalhado da compara√ß√£o para um √∫nico HPA:

```go
type ComparisonResult struct {
    // Identifica√ß√£o
    Cluster   string
    Namespace string
    HPA       string
    Timestamp time.Time

    // Deltas de CPU
    CPUBaseline      float64
    CPUCurrent       float64
    CPUDelta         float64
    CPUDeltaPercent  float64
    CPUExceededLimit bool

    // Deltas de Mem√≥ria
    MemoryBaseline      float64
    MemoryCurrent       float64
    MemoryDelta         float64
    MemoryDeltaPercent  float64
    MemoryExceededLimit bool

    // Deltas de R√©plicas
    ReplicasBaseline      float64
    ReplicasCurrent       int32
    ReplicaDelta          int32
    ReplicaDeltaPercent   float64
    ReplicasExceededLimit bool

    // M√©tricas de aplica√ß√£o
    ErrorRateBaseline  float64
    ErrorRateCurrent   float64
    ErrorRateDelta     float64
    ErrorRateIncreased bool

    LatencyBaseline  float64
    LatencyCurrent   float64
    LatencyDelta     float64
    LatencyIncreased bool

    // Status geral
    Status      ComparisonStatus // NORMAL, DEGRADED, CRITICAL
    Issues      []string         // Lista de problemas detectados
    Severity    string           // info, warning, critical
    Description string           // Descri√ß√£o geral do estado
}
```

### ComparatorConfig

Configura√ß√£o dos thresholds de detec√ß√£o:

```go
type ComparatorConfig struct {
    // Thresholds de CPU
    CPUDegradedThreshold float64 // Default: 30.0%
    CPUCriticalThreshold float64 // Default: 50.0%

    // Thresholds de Mem√≥ria
    MemoryDegradedThreshold float64 // Default: 30.0%
    MemoryCriticalThreshold float64 // Default: 50.0%

    // Thresholds de R√©plicas
    ReplicaDegradedDelta int32   // Default: 3 r√©plicas
    ReplicaCriticalDelta int32   // Default: 5 r√©plicas

    // Thresholds de Aplica√ß√£o
    ErrorRateThreshold float64   // Default: 5.0%
    LatencyThreshold   float64   // Default: 100.0%
}
```

**Configura√ß√£o padr√£o**:
```go
config := analyzer.DefaultComparatorConfig()
// CPU: 30% degraded, 50% critical
// Memory: 30% degraded, 50% critical
// Replicas: +3 degraded, +5 critical
// ErrorRate: +5% critical
// Latency: +100% critical
```

### ComparisonSummary

Resumo agregado de m√∫ltiplas compara√ß√µes:

```go
type ComparisonSummary struct {
    Timestamp time.Time

    // Contadores
    TotalHPAs        int
    NormalCount      int
    DegradedCount    int
    CriticalCount    int
    HealthPercentage float64

    // Listas de HPAs problem√°ticos
    CriticalHPAs []string
    DegradedHPAs []string

    // M√©tricas agregadas
    TotalCPUDelta     float64
    TotalMemoryDelta  float64
    TotalReplicaDelta int
}
```

## üíª Uso

### Exemplo 1: Compara√ß√£o B√°sica

```go
package main

import (
    "context"
    "time"

    "github.com/Paulo-Ribeiro-Log/hpa-watchdog/internal/analyzer"
    "github.com/Paulo-Ribeiro-Log/hpa-watchdog/internal/models"
    "github.com/Paulo-Ribeiro-Log/hpa-watchdog/internal/monitor"
)

func main() {
    // 1. Capturar baseline antes do teste
    baselineCollector := monitor.NewBaselineCollector(promClient, k8sClient)
    baseline, _ := baselineCollector.CaptureBaseline(context.Background(), 30*time.Minute)

    // 2. Criar comparador
    comparator := analyzer.NewStressComparator(baseline, nil) // nil = config padr√£o

    // 3. Durante o teste, comparar cada snapshot
    snapshot := collectCurrentSnapshot() // seu m√©todo de coleta

    result := comparator.CompareWithBaseline(snapshot)

    // 4. Verificar resultado
    switch result.Status {
    case analyzer.StatusNormal:
        log.Info().Msg("HPA operando normalmente")
    case analyzer.StatusDegraded:
        log.Warn().
            Strs("issues", result.Issues).
            Msg("HPA degradado detectado")
    case analyzer.StatusCritical:
        log.Error().
            Strs("issues", result.Issues).
            Msg("HPA cr√≠tico detectado!")
    }
}
```

### Exemplo 2: Compara√ß√£o em Lote

```go
// Comparar todos os snapshots de uma vez
snapshots := collectAllSnapshots() // []*models.HPASnapshot

results := comparator.CompareMultiple(snapshots)

// Gerar resumo
summary := comparator.GetSummary(results)

fmt.Printf("Sa√∫de geral: %.1f%%\n", summary.HealthPercentage)
fmt.Printf("Normal: %d, Degraded: %d, Critical: %d\n",
    summary.NormalCount, summary.DegradedCount, summary.CriticalCount)

// Listar HPAs cr√≠ticos
for _, hpa := range summary.CriticalHPAs {
    fmt.Printf("‚ùå %s\n", hpa)
}
```

### Exemplo 3: Configura√ß√£o Customizada

```go
// Criar config com thresholds mais sens√≠veis
config := &analyzer.ComparatorConfig{
    CPUDegradedThreshold:    15.0, // 15% j√° √© degraded (padr√£o: 30%)
    CPUCriticalThreshold:    30.0, // 30% √© critical (padr√£o: 50%)
    MemoryDegradedThreshold: 20.0,
    MemoryCriticalThreshold: 40.0,
    ReplicaDegradedDelta:    2,    // +2 r√©plicas (padr√£o: 3)
    ReplicaCriticalDelta:    4,    // +4 r√©plicas (padr√£o: 5)
    ErrorRateThreshold:      3.0,  // +3% de erro (padr√£o: 5%)
    LatencyThreshold:        50.0, // +50% de lat√™ncia (padr√£o: 100%)
}

comparator := analyzer.NewStressComparator(baseline, config)
```

## üìä Exemplos de Output

### ComparisonResult - Status Normal

```json
{
  "cluster": "prod-cluster",
  "namespace": "payments",
  "hpa": "payment-api",
  "status": "NORMAL",
  "severity": "info",
  "description": "HPA est√° operando dentro dos limites esperados",
  "cpu_baseline": 50.0,
  "cpu_current": 52.0,
  "cpu_delta": 2.0,
  "cpu_delta_percent": 4.0,
  "memory_baseline": 45.0,
  "memory_current": 46.0,
  "memory_delta": 1.0,
  "memory_delta_percent": 2.2,
  "replicas_baseline": 3.0,
  "replicas_current": 3,
  "replica_delta": 0,
  "issues": []
}
```

### ComparisonResult - Status Degraded

```json
{
  "cluster": "prod-cluster",
  "namespace": "payments",
  "hpa": "payment-api",
  "status": "DEGRADED",
  "severity": "warning",
  "description": "1 degrada√ß√µes detectadas durante stress test",
  "cpu_baseline": 50.0,
  "cpu_current": 67.5,
  "cpu_delta": 17.5,
  "cpu_delta_percent": 35.0,
  "cpu_exceeded_limit": true,
  "issues": [
    "CPU aumentou 35.0% (de 50.0% para 67.5%)"
  ]
}
```

### ComparisonResult - Status Critical

```json
{
  "cluster": "prod-cluster",
  "namespace": "payments",
  "hpa": "payment-api",
  "status": "CRITICAL",
  "severity": "critical",
  "description": "5 problemas cr√≠ticos detectados durante stress test",
  "cpu_baseline": 50.0,
  "cpu_current": 80.0,
  "cpu_delta": 30.0,
  "cpu_delta_percent": 60.0,
  "cpu_exceeded_limit": true,
  "memory_baseline": 45.0,
  "memory_current": 70.0,
  "memory_delta": 25.0,
  "memory_delta_percent": 55.6,
  "memory_exceeded_limit": true,
  "replicas_baseline": 3.0,
  "replicas_current": 9,
  "replica_delta": 6,
  "replica_delta_percent": 200.0,
  "replicas_exceeded_limit": true,
  "error_rate_baseline": 0.5,
  "error_rate_current": 6.0,
  "error_rate_delta": 5.5,
  "error_rate_increased": true,
  "latency_baseline": 100.0,
  "latency_current": 250.0,
  "latency_delta": 150.0,
  "latency_increased": true,
  "issues": [
    "CPU aumentou 60.0% (de 50.0% para 80.0%)",
    "Mem√≥ria aumentou 55.6% (de 45.0% para 70.0%)",
    "R√©plicas aumentaram em 6 (de 3 para 9)",
    "Taxa de erros aumentou 5.50% (de 0.50% para 6.00%)",
    "Lat√™ncia P95 aumentou 150.0% (de 100.0ms para 250.0ms)"
  ]
}
```

### ComparisonSummary

```go
summary.String()
// Output: "Total: 24 HPAs | Normal: 18 | Degraded: 4 | Critical: 2 | Sa√∫de: 75.0%"
```

## üß™ Testes

**Localiza√ß√£o**: `internal/analyzer/stress_comparator_test.go`

### Cobertura de Testes (9/9 ‚úÖ)

| # | Teste | Descri√ß√£o |
|---|-------|-----------|
| 1 | `TestStressComparator_CompareWithBaseline_Normal` | Snapshot normal (sem mudan√ßas significativas) |
| 2 | `TestStressComparator_CompareWithBaseline_Degraded` | CPU degradada (+35%) |
| 3 | `TestStressComparator_CompareWithBaseline_Critical` | M√∫ltiplas m√©tricas cr√≠ticas |
| 4 | `TestStressComparator_CompareWithBaseline_HPANotInBaseline` | HPA novo (n√£o estava no baseline) |
| 5 | `TestStressComparator_CompareMultiple` | Compara√ß√£o em lote |
| 6 | `TestStressComparator_GetSummary` | Gera√ß√£o de resumo |
| 7 | `TestStressComparator_CustomConfig` | Configura√ß√£o customizada |
| 8 | `TestComparatorConfig_Default` | Valores padr√£o da config |
| 9 | `TestComparisonSummary_String` | Representa√ß√£o em string do resumo |

### Executar Testes

```bash
# Executar testes do StressComparator
go test -v ./internal/analyzer/stress_comparator_test.go ./internal/analyzer/stress_comparator.go

# Executar com cobertura
go test -cover ./internal/analyzer/stress_comparator_test.go ./internal/analyzer/stress_comparator.go
```

## üîÑ Integra√ß√£o com Outros Componentes

### 1. BaselineCollector

```go
// Captura baseline antes do teste
baseline, _ := baselineCollector.CaptureBaseline(ctx, 30*time.Minute)

// Cria comparador com baseline
comparator := analyzer.NewStressComparator(baseline, nil)
```

### 2. HPASnapshot

```go
// Coleta snapshot atual
snapshot := collector.CollectSnapshot(ctx, hpa)

// Compara com baseline
result := comparator.CompareWithBaseline(snapshot)
```

### 3. StressTestMetrics

```go
// Durante o teste, acumula resultados
results = append(results, comparator.CompareWithBaseline(snapshot))

// Ao finalizar, gera resumo
summary := comparator.GetSummary(results)

// Salva no StressTestMetrics
stressMetrics.HealthPercentage = summary.HealthPercentage
stressMetrics.TotalHPAsWithIssues = summary.DegradedCount + summary.CriticalCount
```

## üé® Visualiza√ß√£o na TUI

Durante o stress test, o dashboard exibe compara√ß√µes em tempo real:

```
‚ï≠‚îÄ Stress Test Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
‚îÇ                                                           ‚îÇ
‚îÇ  HPA: prod-cluster/payments/payment-api                  ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  Status: DEGRADED ‚ö†Ô∏è                                      ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  ‚îå‚îÄ CPU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ Mem√≥ria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Baseline:   50.0%        ‚îÇ  ‚îÇ Baseline:   45.0%      ‚îÇ‚îÇ
‚îÇ  ‚îÇ Atual:      67.5%        ‚îÇ  ‚îÇ Atual:      48.0%      ‚îÇ‚îÇ
‚îÇ  ‚îÇ Delta:     +17.5% (+35%) ‚îÇ  ‚îÇ Delta:      +3.0% (+7%)‚îÇ‚îÇ
‚îÇ  ‚îÇ Status:     ‚ö†Ô∏è DEGRADED  ‚îÇ  ‚îÇ Status:     ‚úÖ NORMAL  ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  Issues:                                                  ‚îÇ
‚îÇ  ‚Ä¢ CPU aumentou 35.0% (de 50.0% para 67.5%)              ‚îÇ
‚îÇ                                                           ‚îÇ
‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
```

## ‚öôÔ∏è Configura√ß√£o Avan√ßada

### Thresholds Personalizados por Ambiente

```go
// Produ√ß√£o - thresholds rigorosos
prodConfig := &analyzer.ComparatorConfig{
    CPUDegradedThreshold: 20.0,
    CPUCriticalThreshold: 40.0,
    // ...
}

// Staging - thresholds relaxados
stagingConfig := &analyzer.ComparatorConfig{
    CPUDegradedThreshold: 50.0,
    CPUCriticalThreshold: 80.0,
    // ...
}
```

### Filtrar apenas HPAs Cr√≠ticos

```go
results := comparator.CompareMultiple(snapshots)

criticalResults := []analyzer.ComparisonResult{}
for _, result := range results {
    if result.Status == analyzer.StatusCritical {
        criticalResults = append(criticalResults, result)
    }
}
```

## üìù Pr√≥ximos Passos

1. ‚úÖ **StressComparator implementado**
2. ‚è≠Ô∏è **Integrar no Engine** (pr√≥xima tarefa)
3. ‚è≠Ô∏è Adicionar visualiza√ß√£o na TUI
4. ‚è≠Ô∏è Implementar alertas em tempo real
5. ‚è≠Ô∏è Gerar relat√≥rios com compara√ß√µes

## üêõ Troubleshooting

### HPA n√£o encontrado no baseline

**Problema**: `ComparisonResult` retorna status NORMAL com issue "HPA n√£o encontrado no baseline"

**Causa**: HPA foi criado ap√≥s captura do baseline

**Solu√ß√£o**: Re-capturar baseline antes do teste ou filtrar HPAs novos

### Deltas muito sens√≠veis

**Problema**: Muitos falsos positivos (HPAs marcados como degraded)

**Causa**: Thresholds padr√£o muito baixos para seu ambiente

**Solu√ß√£o**: Ajustar thresholds usando `ComparatorConfig` customizado

### Deltas n√£o detectados

**Problema**: Degrada√ß√µes reais n√£o sendo detectadas

**Causa**: Thresholds muito altos

**Solu√ß√£o**: Reduzir thresholds ou verificar se baseline foi capturado corretamente

## ‚úÖ Resumo

- ‚úÖ **Implementado**: StressComparator completo
- ‚úÖ **Testes**: 9/9 testes passando
- ‚úÖ **Documenta√ß√£o**: Completa
- ‚úÖ **Integra√ß√£o**: Usa `models.BaselineSnapshot` (sem import cycle)
- ‚è≠Ô∏è **Pr√≥ximo**: Integrar no Engine para uso em stress tests
